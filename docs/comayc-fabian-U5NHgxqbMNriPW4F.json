{"createdAt":"2024-11-28T17:36:27.029Z","updatedAt":"2024-12-21T22:28:55.509Z","id":"U5NHgxqbMNriPW4F","name":"COMAYC FABIAN","active":true,"nodes":[{"parameters":{"functionCode":"try {\n    // Funci√≥n para parsear n√∫meros grandes\n    function parseNumeroUruguayo(valor) {\n    if (typeof valor === 'number') return valor;\n    \n    if (!valor || typeof valor !== 'string') {\n        return NaN;\n    }\n      \n    // Paso 1: Verificar si contiene letras\n    if (/[a-zA-Z]/.test(valor)) {\n        return NaN; // Retornamos NaN para que sea manejado en las validaciones posteriores\n    }\n\n    // Paso 1: Eliminar espacios y s√≠mbolo de peso\n    let numeroLimpio = valor.toString()\n        .replace(/\\s/g, '')\n        .replace(/\\$/g, '');\n\n    // Paso 2: Si hay puntos, son separadores de miles, eliminarlos\n    numeroLimpio = numeroLimpio.replace(/\\./g, '');\n\n    // Paso 3: Convertir coma a punto decimal si existe\n    numeroLimpio = numeroLimpio.replace(',', '.');\n\n    console.log('N√∫mero antes de parsear:', valor, '‚Üí', numeroLimpio);\n    const resultado = parseFloat(numeroLimpio);\n    console.log('N√∫mero despu√©s de parsear:', resultado);\n    \n    return resultado;\n}\n\n    // Funci√≥n para formatear n√∫meros en formato uruguayo\n    function formatearNumero(numero) {\n        return new Intl.NumberFormat('es-UY', {\n            minimumFractionDigits: 0, // Cambiado de 2 a 0\n            maximumFractionDigits: 2  // Mantenemos 2 como m√°ximo por si hay decimales\n        }).format(numero);\n    }\n\n    // Funci√≥n para c√°lculo de margen\n    function calculoMargenUY(nominal, liquido) {\n        const minimoLegalUY = nominal * 0.35;\n        const diferencia = liquido - minimoLegalUY;\n        const margenMinimo = 3000;\n        return {\n            tieneMargen: diferencia > margenMinimo,\n            margenDisponible: diferencia\n        };\n    }\n\n    // Funciones para mensajes de respuesta\n    function obtenerMensajeSegunTipo(tipoUsuario, resultado) {\n        return resultado.tieneMargen \n            ? obtenerMensajeAprobado(tipoUsuario)\n            : obtenerMensajeRechazado(tipoUsuario);\n    }\n\n    function obtenerMensajeAprobado(tipoUsuario) {\n    const mensajeFinal = \"\\n\\n*Una vez recibidos, procederemos a evaluar su solicitud, dentro del horario de atenci√≥n al p√∫blico, lunes a viernes de 9 a 17 horas.*\";\n\n    if (tipoUsuario === 'empleado') {\n        return `Est√° en condiciones de solicitar un cr√©dito. Por favor, env√≠enos fotos n√≠tidas y legibles de la siguiente documentaci√≥n:\\n\\n‚Ä¢ ùóñùó≤ÃÅùó±ùòÇùóπùóÆ ùó±ùó≤ ùó∂ùó±ùó≤ùóªùòÅùó∂ùó±ùóÆùó± ùòÉùó∂ùó¥ùó≤ùóªùòÅùó≤\\n‚Ä¢ ùó®ÃÅùóπùòÅùó∂ùó∫ùóºùòÄ ùó±ùóºùòÄ ùóøùó≤ùó∞ùó∂ùóØùóºùòÄ ùó±ùó≤ ùòÄùòÇùó≤ùóπùó±ùóº\\n‚Ä¢ ùóñùóºùóªùòÄùòÅùóÆùóªùó∞ùó∂ùóÆ ùó±ùó≤ ùó±ùóºùó∫ùó∂ùó∞ùó∂ùóπùó∂ùóº (ùóΩùòÇùó≤ùó±ùó≤ ùòÄùó≤ùóø ùòÇùóª ùóøùó≤ùó∞ùó∂ùóØùóº ùó±ùó≤ ùó®ùóßùóò, ùó¢ùó¶ùóò, ùóîùó°ùóßùóòùóü, ùó≤ùòÄùòÅùóÆùó±ùóº ùó±ùó≤ ùó∞ùòÇùó≤ùóªùòÅùóÆ, ùó≤ùòÅùó∞.) \\n\\nùó®ùóªùóÆ ùòÉùó≤ùòá ùóøùó≤ùó∞ùó∂ùóØùó∂ùó±ùóºùòÄ, ùóΩùóøùóºùó∞ùó≤ùó±ùó≤ùóøùó≤ùó∫ùóºùòÄ ùóÆ ùó≤ùòÉùóÆùóπùòÇùóÆùóø ùòÄùòÇ ùòÄùóºùóπùó∂ùó∞ùó∂ùòÅùòÇùó±, ùó±ùó≤ùóªùòÅùóøùóº ùó±ùó≤ùóπ ùóµùóºùóøùóÆùóøùó∂ùóº ùó±ùó≤ ùóÆùòÅùó≤ùóªùó∞ùó∂ùóºÃÅùóª ùóÆùóπ ùóΩùòÇÃÅùóØùóπùó∂ùó∞ùóº, ùóπùòÇùóªùó≤ùòÄ ùóÆ ùòÉùó∂ùó≤ùóøùóªùó≤ùòÄ ùó±ùó≤ ùüµ ùóÆ ùü≠ùü≥ ùóµùóºùóøùóÆùòÄ.`;\n    } else if (tipoUsuario === 'jubilado') {\n        return `Est√° en condiciones de solicitar un cr√©dito. Por favor, env√≠enos fotos n√≠tidas y legibles de la siguiente documentaci√≥n:\\n\\n‚Ä¢ ùóñùó≤ÃÅùó±ùòÇùóπùóÆ ùó±ùó≤ ùó∂ùó±ùó≤ùóªùòÅùó∂ùó±ùóÆùó± ùòÉùó∂ùó¥ùó≤ùóªùòÅùó≤\\n‚Ä¢ ùó®ÃÅùóπùòÅùó∂ùó∫ùóºùòÄ ùó±ùóºùòÄ ùóøùó≤ùó∞ùó∂ùóØùóºùòÄ ùó±ùó≤ ùóπùóÆ ùóΩùóÆùòÄùó∂ùòÉùó∂ùó±ùóÆùó±\\n‚Ä¢ ùóñùóºùóªùòÄùòÅùóÆùóªùó∞ùó∂ùóÆ ùó±ùó≤ ùó±ùóºùó∫ùó∂ùó∞ùó∂ùóπùó∂ùóº (ùóΩùòÇùó≤ùó±ùó≤ ùòÄùó≤ùóø ùòÇùóª ùóøùó≤ùó∞ùó∂ùóØùóº ùó±ùó≤ ùó®ùóßùóò, ùó¢ùó¶ùóò, ùóîùó°ùóßùóòùóü, ùó≤ùòÄùòÅùóÆùó±ùóº ùó±ùó≤ ùó∞ùòÇùó≤ùóªùòÅùóÆ, ùó≤ùòÅùó∞.) \\n\\nùó®ùóªùóÆ ùòÉùó≤ùòá ùóøùó≤ùó∞ùó∂ùóØùó∂ùó±ùóºùòÄ, ùóΩùóøùóºùó∞ùó≤ùó±ùó≤ùóøùó≤ùó∫ùóºùòÄ ùóÆ ùó≤ùòÉùóÆùóπùòÇùóÆùóø ùòÄùòÇ ùòÄùóºùóπùó∂ùó∞ùó∂ùòÅùòÇùó±, ùó±ùó≤ùóªùòÅùóøùóº ùó±ùó≤ùóπ ùóµùóºùóøùóÆùóøùó∂ùóº ùó±ùó≤ ùóÆùòÅùó≤ùóªùó∞ùó∂ùóºÃÅùóª ùóÆùóπ ùóΩùòÇÃÅùóØùóπùó∂ùó∞ùóº, ùóπùòÇùóªùó≤ùòÄ ùóÆ ùòÉùó∂ùó≤ùóøùóªùó≤ùòÄ ùó±ùó≤ ùüµ ùóÆ ùü≠ùü≥ ùóµùóºùóøùóÆùòÄ.`;\n    }\n}\n\nfunction obtenerMensajeRechazado(tipoUsuario) {\n    return `Gracias por su consulta. Por ahora no cuenta con el margen necesario, puede consultar m√°s adelante.`;\n}\n\n    // Obtener y validar el input\n    const inputData = $input.all()[0].json.body;\n    console.log(\"Datos recibidos:\", JSON.stringify(inputData));\n\n    if (!inputData || !inputData.parameters) {\n        return {\n            json: {\n                status: \"error\",\n                message: \"Error: Formato de entrada inv√°lido\",\n                debug: { received: inputData }\n            }\n        };\n    }\n\n    // Determinar tipo de usuario y obtener montos\n    const parameters = inputData.parameters;\n    let tipoUsuario;\n    let montoNominal;\n    let montoLiquido;\n\n    if ('montoNominal_jubilado' in parameters && 'montoLiquido_jubilado' in parameters) {\n        tipoUsuario = 'jubilado';\n        montoNominal = parseNumeroUruguayo(parameters.montoNominal_jubilado);\n        montoLiquido = parseNumeroUruguayo(parameters.montoLiquido_jubilado);\n    } else if ('montoNominal_empleado' in parameters && 'montoLiquido_empleado' in parameters) {\n        tipoUsuario = 'empleado';\n        montoNominal = parseNumeroUruguayo(parameters.montoNominal_empleado);\n        montoLiquido = parseNumeroUruguayo(parameters.montoLiquido_empleado);\n    } else {\n        return {\n            json: {\n                status: \"error\",\n                message: \"No se pudo determinar el tipo de usuario o faltan par√°metros necesarios\",\n                debug: { parameters }\n            }\n        };\n    }\n\n    console.log(\"Tipo de usuario detectado:\", tipoUsuario);\n\n  // Validaci√≥n de letras en los montos\nconst contieneLetras = /[a-zA-Z]/.test(parameters.montoNominal_jubilado || parameters.montoNominal_empleado || '') ||\n                       /[a-zA-Z]/.test(parameters.montoLiquido_jubilado || parameters.montoLiquido_empleado || '');\n\nif (contieneLetras) {\n    return {\n        json: {\n            status: \"error\",\n            message: \"Uno o m√°s de los valores proporcionados contienen letras y no son v√°lidos. \\n\\nTe voy a redirigir a las preguntas correspondientes para poder decirte con exactitud si estas calificado para la solicitud de un cr√©dito\",\n            debug: { \n                parametrosOriginales: parameters\n            }\n        }\n    };\n}\n  \n   // Validaciones de montos\n   if (isNaN(montoNominal) || isNaN(montoLiquido)) {\n    return {\n        json: {\n            status: \"error\",\n            message: \"Error: Los montos proporcionados no son v√°lidos\",\n            debug: { \n                montoNominal,\n                montoLiquido,\n                parametrosOriginales: parameters\n            }\n        }\n     };\n   }\n\n\n    // Validaci√≥n de l√≠mites y negativos\n    if (montoNominal > Number.MAX_SAFE_INTEGER || montoLiquido > Number.MAX_SAFE_INTEGER) {\n        return {\n            json: {\n                status: \"error\",\n                message: \"Los montos ingresados son demasiado grandes para procesar\",\n                debug: { \n                    montoNominal,\n                    montoLiquido,\n                    maxPermitido: Number.MAX_SAFE_INTEGER\n                }\n            }\n        };\n    }\n\n    if (montoNominal < 0 || montoLiquido < 0) {\n        return {\n            json: {\n                status: \"error\",\n                message: \"Los montos no pueden ser negativos\",\n                debug: { \n                    montoNominal,\n                    montoLiquido\n                }\n            }\n        };\n    }\n\n  // Validaci√≥n de montos nominal vs l√≠quido\n    if (montoLiquido >= montoNominal) {\n        return {\n            json: {\n                status: \"error\",\n                message: \"Por favor corrija los montos y vuelva a ingresarlos. El monto l√≠quido no puede ser mayor o igual al monto nominal. \\n\\nTe voy a redirigir a las preguntas correspondientes para poder decirte con exactitud si estas calificado para la solicitud del cr√©dito\",\n                debug: { \n                    montoNominal: formatearNumero(montoNominal),\n                    montoLiquido: formatearNumero(montoLiquido)\n                }\n            }\n        };\n    }\n\n    // Realizar el c√°lculo\n    const resultado = calculoMargenUY(montoNominal, montoLiquido);\n    \n    console.log(\"Resultado del c√°lculo:\", {\n        tipoUsuario,\n        ...resultado,\n        margenDisponibleFormateado: formatearNumero(resultado.margenDisponible)\n    });\n\n    // Obtener mensaje de respuesta\n    const mensajeRespuesta = obtenerMensajeSegunTipo(tipoUsuario, resultado);\n\n    // Retornar respuesta final\n    return {\n        json: {\n            status: \"success\",\n            message: mensajeRespuesta,\n            data: {\n                tipoUsuario,\n                tieneMargen: resultado.tieneMargen,\n                margenDisponible: formatearNumero(resultado.margenDisponible),\n                valoresProcesados: {\n                    montoNominal: formatearNumero(montoNominal),\n                    montoLiquido: formatearNumero(montoLiquido)\n                }\n            }\n        }\n    };\n\n} catch (error) {\n    console.error(\"Error en el procesamiento:\", error);\n    return {\n        json: {\n            status: \"error\",\n            message: \"Error en el procesamiento de la solicitud\",\n            debug: { \n                error: error.message,\n                stack: error.stack\n            }\n        }\n    };\n}"},"name":"Code","type":"n8n-nodes-base.function","typeVersion":1,"position":[660,440],"id":"856e6d63-2926-48bc-bafd-4171dea463c5"},{"parameters":{"httpMethod":"POST","path":"respond","responseMode":"lastNode","options":{}},"name":"Webhook","type":"n8n-nodes-base.webhook","typeVersion":1,"position":[400,440],"id":"ce7d0765-5090-40b5-85b5-b299cbf567c8","webhookId":"5da6d752-9554-46d5-986e-6b7c553385fd"}],"connections":{"Webhook":{"main":[[{"node":"Code","type":"main","index":0}]]}},"settings":{"executionOrder":"v1","callerPolicy":"workflowsFromSameOwner"},"staticData":null,"meta":{"templateCredsSetupCompleted":true},"pinData":{},"versionId":"2c91488f-0c2c-4279-a3bb-c6ff011725dd","triggerCount":1,"tags":[{"createdAt":"2024-11-27T05:11:34.741Z","updatedAt":"2024-11-27T05:11:34.741Z","id":"lkTQ85NNYkbxB1mk","name":"Prod"}]}